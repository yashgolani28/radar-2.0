{% extends "base.html" %}
{% block title %}Snapshot Gallery{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold" style="color: var(--text-color);">Detection Gallery</h2>
    <span class="badge bg-info text-dark">{{ snapshots|length }} Images</span>
</div>

<!-- Filters -->
<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title">Filters</h5>

    <form method="GET" class="row g-3" id="filterForm" action="{{ url_for('gallery') }}">
    <input type="hidden" name="download" value="0">

    <!-- Row 1: Speed, Type, Direction, Motion, Snapshot Type -->
    <div class="col-md-2">
        <label class="form-label">Min Speed (km/h)</label>
        <input type="number" name="min_speed" class="form-control" step="0.1"
            value="{{ request.args.get('min_speed', '') }}" placeholder="0">
    </div>
    <div class="col-md-2">
        <label class="form-label">Max Speed (km/h)</label>
        <input type="number" name="max_speed" class="form-control" step="0.1"
            value="{{ request.args.get('max_speed', '') }}" placeholder="999">
    </div>
    <div class="col-md-2">
        <label class="form-label">Object Type</label>
        <select name="type" class="form-select">
        <option value="">All Types</option>
        {% for opt in ['VEHICLE', 'HUMAN', 'CAR', 'TRUCK', 'BIKE', 'UNKNOWN'] %}
            <option value="{{ opt }}" {% if request.args.get('type') == opt %}selected{% endif %}>{{ opt.title() }}</option>
        {% endfor %}
        </select>
    </div>
    <div class="col-md-2">
        <label class="form-label">Direction</label>
        <select name="direction" class="form-select">
        <option value="">All</option>
        {% for opt in ['Towards', 'Away','Stationary','Right', 'Left','Unknown']%}
            <option value="{{ opt }}" {% if request.args.get('direction') == opt %}selected{% endif %}>{{ opt.title() }}</option>
        {% endfor %}
        </select>
    </div>
    <div class="col-md-2">
        <label class="form-label">Motion</label>
        <select name="motion_state" class="form-select">
        <option value="">All</option>
        {% for opt in ['moving', 'speeding', 'static'] %}
            <option value="{{ opt }}" {% if request.args.get('motion_state') == opt %}selected{% endif %}>{{ opt.title() }}</option>
        {% endfor %}
        </select>
    </div>
    <div class="col-md-2">
        <label class="form-label">Snapshot Type</label>
        <select name="snapshot_type" class="form-select">
        <option value="">All</option>
        <option value="manual" {% if request.args.get('snapshot_type') == 'manual' %}selected{% endif %}>Manual</option>
        <option value="auto" {% if request.args.get('snapshot_type') == 'auto' %}selected{% endif %}>Auto</option>
        </select>
    </div>

    <!-- Row 2: Dates and Object ID -->
    <div class="col-md-3">
        <label class="form-label">Start Date</label>
        <input type="date" name="start_date" class="form-control"
            value="{{ request.args.get('start_date', '') }}">
    </div>
    <div class="col-md-3">
        <label class="form-label">End Date</label>
        <input type="date" name="end_date" class="form-control"
            value="{{ request.args.get('end_date', '') }}">
    </div>
    <div class="col-md-6">
        <label class="form-label">Object ID</label>
        <input type="text" name="object_id" class="form-control"
            value="{{ request.args.get('object_id', '') }}" placeholder="Search by ID">
    </div>

    <!-- Row 3: Confidence, Pagination, Checkboxes (all in same row) -->
    <div class="col-md-2">
    <label class="form-label">Min Confidence</label>
    <input type="number" name="min_confidence" class="form-control" step="0.01" min="0" max="1"
            value="{{ request.args.get('min_confidence', '') }}" placeholder="0.0">
    </div>
    <div class="col-md-2">
    <label class="form-label">Max Confidence</label>
    <input type="number" name="max_confidence" class="form-control" step="0.01" min="0" max="1"
            value="{{ request.args.get('max_confidence', '') }}" placeholder="1.0">
    </div>
    <div class="col-md-2">
    <label class="form-label">Page</label>
    <input type="number" name="page" class="form-control" min="1"
            value="{{ request.args.get('page', 1) }}">
    </div>
    <div class="col-md-2">
    <label class="form-label">Limit</label>
    <input type="number" name="limit" class="form-control" min="10"
            value="{{ request.args.get('limit', 100) }}">
    </div>

    <!-- Checkboxes beside the inputs -->
    <div class="col-md-4 d-flex align-items-end gap-3 flex-wrap">
    <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="reviewed_only" value="1" id="reviewed_only"
            {% if request.args.get('reviewed_only') == '1' %}checked{% endif %}>
        <label class="form-check-label" for="reviewed_only">Reviewed</label>
    </div>
    <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="flagged_only" value="1" id="flagged_only"
            {% if request.args.get('flagged_only') == '1' %}checked{% endif %}>
        <label class="form-check-label" for="flagged_only">Flagged</label>
    </div>
    <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="unannotated_only" value="1" id="unannotated_only"
            {% if request.args.get('unannotated_only') == '1' %}checked{% endif %}>
        <label class="form-check-label" for="unannotated_only">Unannotated</label>
    </div>
    </div>

    <!-- Row 5: Action Buttons -->
    <div class="col-12 mt-3">
        <hr class="my-3">
        <div class="row g-2">
        <div class="col-md-3">
            <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('gallery') }}" class="btn btn-primary w-100">Clear Filters</a>
        </div>
        <div class="col-md-3">
            <button type="button" id="downloadZipBtn" class="btn btn-primary w-100">Download ZIP</button>
        </div>
        <div class="col-md-3">
            <button type="button" id="downloadPdfBtn" class="btn btn-primary w-100">Download PDF</button>
        </div>
        </div>
    </div>
    </form>
  </div>
</div>

<!-- Gallery -->
{% if snapshots %}

<style>
  /* Compact gallery cards */
  .gallery-card .card-img-top{height:140px;object-fit:cover}
  .gallery-card .card-body{padding:.5rem}
  .gallery-card h6{font-size:.95rem;margin-bottom:.25rem}
  .gallery-card small{font-size:.78rem}
</style>

<div class="row row-cols-2 row-cols-md-4 row-cols-xl-6 g-3" id="galleryContainer">
  {% for snap in snapshots %}
  <div class="col" data-snapshot="{{ snap.filename }}">
    <div class="card h-100 gallery-card">
      <div class="position-relative">
        <div class="gallery-image-container" 
          data-image="/snapshots/{{ snap.filename }}"
          data-title="{{ snap.type }} Detection"
          data-type="{{ snap.type }}"
          data-speed="{{ snap.speed }}"
          data-distance="{{ snap.distance }}"
          data-azimuth="{{ snap.azimuth }}"
          data-elevation="{{ snap.elevation }}"
          data-direction="{{ snap.direction }}"
          data-motion-state="{{ snap.motion_state }}"
          data-datetime="{{ snap.datetime }}"
          data-filename="{{ snap.filename }}"
          data-object-id="{{ snap.object_id or '' }}"
          data-confidence="{{ snap.confidence or '' }}"
          data-snapshot-status="{{ snap.snapshot_status }}"
          data-snapshot-type="{{ snap.snapshot_type }}"
          data-reviewed="{{ snap.reviewed | string | lower }}"
          data-flagged="{{ snap.flagged | string | lower }}"
          style="cursor:pointer;">
          <img src="/snapshots/{{ snap.filename }}" class="card-img-top"
               alt="{{ snap.type }} Detection - {{ snap.datetime }}">
        </div>

        {% set speed = snap.speed or 0 %}
        {% if speed > 2 %}
          <span class="position-absolute top-0 end-0 m-2 badge bg-danger">
        {% elif speed > 1 %}
          <span class="position-absolute top-0 end-0 m-2 badge bg-warning">
        {% else %}
          <span class="position-absolute top-0 end-0 m-2 badge bg-success">
        {% endif %}
          {{ speed }} km/h
          </span>

        {% set confidence = snap.confidence if snap.confidence is not none else 0 %}
        {% if confidence %}
        <span class="position-absolute top-0 start-0 m-2 badge bg-info">
          {{ (confidence * 100)|round(0)|int }}%
        </span>
        {% endif %}
      </div>

      <div class="card-body">
        <h6 class="card-title">{{ snap.type|default("Unknown")|title }}</h6>
        <small class="text-muted d-block">{{ snap.datetime }}</small>

        {% if snap.snapshot_type or snap.snapshot_status %}
        <div class="mt-1">
          {% if snap.snapshot_type %}
          <span class="badge bg-info text-dark me-1">{{ snap.snapshot_type|title }}</span>
          {% endif %}
          {% if snap.snapshot_status %}
          <span class="badge bg-secondary">{{ snap.snapshot_status|title }}</span>
          {% endif %}
        </div>
        {% endif %}

        <div class="mt-2">
          <small class="d-block">Speed: {{ snap.speed }} km/h · Dist: {{ snap.distance }} m</small>
          <small class="d-block">
            Dir: {{ snap.direction|default("N/A")|title }}
            {% if snap.motion_state %} · Mot: {{ snap.motion_state|title }}{% endif %}
          </small>

          {% if snap.object_id %}
          <small class="d-block">ID: {{ snap.object_id }}</small>
          {% if snap.azimuth is not none and snap.elevation is not none %}
          <small class="d-block">Az: {{ snap.azimuth }}°, El: {{ snap.elevation }}°</small>
          {% endif %}
          {% endif %}
        </div>
      </div>

      {% if current_user.is_authenticated %}
      <div class="mt-2 d-flex gap-1 px-2 pb-2" data-snapshot-controls="{{ snap.filename }}">
        <button type="button"
                class="btn btn-sm {{ 'btn-success' if snap.reviewed else 'btn-outline-primary' }} mark-reviewed-btn"
                data-filename="{{ snap.filename }}"
                data-current-state="{{ snap.reviewed|lower }}">
          <span class="btn-text">{{ 'Unmark' if snap.reviewed else 'Mark Reviewed' }}</span>
          <span class="loading-spinner d-none">
            <span class="spinner-border spinner-border-sm" role="status"></span>
          </span>
        </button>
        <button type="button"
                class="btn btn-sm {{ 'btn-danger' if snap.flagged else 'btn-outline-warning' }} mark-flagged-btn"
                data-filename="{{ snap.filename }}"
                data-current-state="{{ snap.flagged|lower }}">
          <span class="btn-text">{{ 'Unflag' if snap.flagged else 'Flag' }}</span>
          <span class="loading-spinner d-none">
            <span class="spinner-border spinner-border-sm" role="status"></span>
          </span>
        </button>
      </div>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

<!-- Snapshot Count Info -->
<div class="row mt-4">
  <div class="col-12 text-center">
    <p class="text-muted">
      Showing {{ snapshots|length }} snapshots
      {% if request.args.get('min_speed') or request.args.get('max_speed') or request.args.get('type') or request.args.get('direction') or request.args.get('reviewed_only') or request.args.get('flagged_only') %}
        with applied filters
      {% endif %}
    </p>
  </div>
</div>

{% else %}

<div class="card">
  <div class="card-body text-center py-5">
    <h5>No Images Found</h5>
    <p class="text-muted">Try adjusting your filters or check back later for new detections.</p>
    <a href="{{ url_for('gallery') }}" class="btn btn-primary">Clear All Filters</a>
  </div>
</div>

{% endif %}

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Detection Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <div class="row g-0">
          <!-- Left: Image -->
          <div class="col-md-8">
            <img id="modalImage" src="" class="img-fluid w-100" alt="Detection Image"
                 style="max-height:70vh;object-fit:contain;">
          </div>
          <!-- Right: Data -->
          <div class="col-md-4 p-3">
            <h6 class="fw-bold mb-3">Detection Information</h6>
            <div class="mb-2"><strong>Type:</strong> <span id="modalType"></span></div>
            <div class="mb-2"><strong>Speed:</strong> <span id="modalSpeed"></span> km/h</div>
            <div class="mb-2"><strong>Distance:</strong> <span id="modalDistance"></span> m</div>
            <div class="mb-2"><strong>Azimuth:</strong> <span id="modalAzimuth"></span>°</div>
            <div class="mb-2"><strong>Elevation:</strong> <span id="modalElevation"></span>°</div>
            <div class="mb-2"><strong>Direction:</strong> <span id="modalDirection"></span></div>
            <div class="mb-2"><strong>Motion:</strong> <span id="modalMotion"></span></div>
            <div class="mb-2"><strong>Time:</strong> <span id="modalDatetime"></span></div>
            <div class="mb-2" id="modalObjectIdRow" style="display:none;">
              <strong>Object ID:</strong> <span id="modalObjectId"></span>
            </div>
            <div class="mb-2" id="modalConfidenceRow" style="display:none;">
              <strong>Confidence:</strong> <span id="modalConfidence"></span>%
            </div>
            <div class="mb-2"><strong>Filename:</strong> <span id="modalFilename"></span></div>
            <div class="mb-2"><strong>Snapshot Type:</strong> <span id="modalSnapshotType"></span></div>
            <div class="mb-2"><strong>Status:</strong> <span id="modalStatus"></span></div>
            <div class="mb-2"><strong>Reviewed:</strong> <span id="modalReviewed"></span></div>
            <div class="mb-2"><strong>Flagged:</strong> <span id="modalFlagged"></span></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a id="downloadBtn" href="#" class="btn btn-success" download>
          <i class="fas fa-download me-2"></i>Download
        </a>
        <button type="button" class="btn btn-danger" id="deleteBtn">
          <i class="fas fa-trash me-2"></i>Delete
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Download Confirmation Modal -->
<div class="modal fade" id="downloadConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Download</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to download a ZIP file containing <strong id="download-count"></strong> images?</p>
        <p class="text-muted">This may take some time depending on the number of images.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="confirmDownloadBtn">
          <span class="btn-text">Yes, Download</span>
          <span class="loading-spinner d-none">
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            Preparing...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  function ensureSingleModal(id) {
    const nodes = document.querySelectorAll('#' + id);
    nodes.forEach((el, idx) => { if (idx > 0) el.remove(); });
    return document.getElementById(id);
  }

  // pre-dedupe on load
  ensureSingleModal('imageModal');
  ensureSingleModal('downloadConfirmModal');
  let currentImageData = null;

  // Open modal on image click
  document.querySelectorAll('.gallery-image-container').forEach(container => {
    container.addEventListener('click', function(e) {
      e.preventDefault();
      openImageModal(this);
    });
  });

  // Mark buttons (delegated)
  document.addEventListener('click', function(e) {
    const btnReviewed = e.target.closest('.mark-reviewed-btn');
    const btnFlagged  = e.target.closest('.mark-flagged-btn');
    if (!btnReviewed && !btnFlagged) return;

    e.preventDefault();
    e.stopPropagation(); // don’t trigger image click

    const button = btnReviewed || btnFlagged;
    const action = btnReviewed ? 'reviewed' : 'flagged';
    handleMarkAction(button, action);
  });

  // Download ZIP
  document.getElementById('downloadZipBtn')?.addEventListener('click', showDownloadConfirmation);
  // Download PDF
  document.getElementById('downloadPdfBtn')?.addEventListener('click', function() {
    const currentUrl = new URL(window.location);
    window.location.href = "{{ url_for('export_filtered_pdf') }}" + currentUrl.search.replace(/^\?/, '?');
  });
  document.getElementById('confirmDownloadBtn')?.addEventListener('click', handleZipDownload);

  function openImageModal(container) {

    // if a previous modal/backdrop got stuck, clear it
    if (window.cleanupModals) window.cleanupModals();

    const modalEl = ensureSingleModal('imageModal');
    const modal = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: true });
    currentImageData = {
      image: container.dataset.image,
      title: container.dataset.title,
      type: container.dataset.type,
      speed: container.dataset.speed,
      distance: container.dataset.distance,
      azimuth: container.dataset.azimuth,
      elevation: container.dataset.elevation,
      direction: container.dataset.direction,
      motion: container.dataset.motionState || container.dataset.motion,
      datetime: container.dataset.datetime,
      filename: container.dataset.filename,
      objectId: container.dataset.objectId,
      confidence: container.dataset.confidence,
      snapshotType: container.dataset.snapshotType,
      snapshotStatus: container.dataset.snapshotStatus,
      reviewed: container.dataset.reviewed === 'true',
      flagged: container.dataset.flagged === 'true'
    };

    document.getElementById('modalTitle').textContent = currentImageData.title || 'Detection Details';
    document.getElementById('modalImage').src = currentImageData.image;
    document.getElementById('modalType').textContent = currentImageData.type || 'N/A';
    document.getElementById('modalSpeed').textContent = currentImageData.speed || '0';
    document.getElementById('modalDistance').textContent = currentImageData.distance || '0';
    const az = document.getElementById('modalAzimuth'); if (az) az.textContent = currentImageData.azimuth || '0';
    const el = document.getElementById('modalElevation'); if (el) el.textContent = currentImageData.elevation || '0';
    document.getElementById('modalDirection').textContent = formatText(currentImageData.direction);
    document.getElementById('modalMotion').textContent = formatText(currentImageData.motion);
    document.getElementById('modalDatetime').textContent = currentImageData.datetime || 'N/A';
    document.getElementById('modalFilename').textContent = currentImageData.filename || 'N/A';
    const mst = document.getElementById('modalSnapshotType'); if (mst) mst.textContent = formatText(currentImageData.snapshotType);
    document.getElementById('modalStatus').textContent = formatText(currentImageData.snapshotStatus);
    document.getElementById('modalReviewed').textContent = currentImageData.reviewed ? 'Yes' : 'No';
    document.getElementById('modalFlagged').textContent = currentImageData.flagged ? 'Yes' : 'No';

    if (currentImageData.objectId) {
      document.getElementById('modalObjectId').textContent = currentImageData.objectId;
      document.getElementById('modalObjectIdRow').style.display = 'block';
    } else {
      document.getElementById('modalObjectIdRow').style.display = 'none';
    }

    if (currentImageData.confidence !== undefined && currentImageData.confidence !== "") {
      const confidencePercent = Math.round(parseFloat(currentImageData.confidence) * 100);
      document.getElementById('modalConfidence').textContent = confidencePercent;
      document.getElementById('modalConfidenceRow').style.display = 'block';
    } else {
      document.getElementById('modalConfidenceRow').style.display = 'none';
    }

    setupDownloadButton();
    setupDeleteButton();

    modal.show();
  }

  function formatText(t) { return t ? (t.charAt(0).toUpperCase() + t.slice(1)) : 'N/A'; }

  function setupDownloadButton() {
    const downloadBtn = document.getElementById('downloadBtn');
    downloadBtn.onclick = function() {
      const link = document.createElement('a');
      link.href = currentImageData.image;
      link.download = currentImageData.filename;
      link.click();
    };
  }

  function setupDeleteButton() {
    const deleteBtn = document.getElementById('deleteBtn');
    if (!deleteBtn) return;
    deleteBtn.onclick = function() {
      if (!confirm(`Delete snapshot "${currentImageData.filename}"?`)) return;
      fetch(`/delete_snapshot/${currentImageData.filename}`, { method: "DELETE" })
        .then(res => res.json())
        .then(resp => {
          if (resp.success) { location.reload(); }
          else { alert("Delete failed: " + resp.error); }
        })
        .catch(() => alert("Delete failed"));
    };
  }

  async function handleMarkAction(button, action) {
    if (button.disabled) return;
    const filename = button.dataset.filename;
    const currentState = (button.dataset.currentState === 'true');

    showButtonLoading(button);
    try {
      const response = await fetch('/mark_snapshot', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
        body: JSON.stringify({ snapshot: filename, action: action })
      });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();

      if (data.status === 'updated') {
        updateButton(button, action, !currentState);
        showAlert(`Snapshot ${currentState ? 'un' : ''}${action} successfully`, 'success');

        // keep dataset in sync for modal
        const col = button.closest('[data-snapshot]');
        const container = col?.querySelector('.gallery-image-container');
        if (container) {
          if (action === 'reviewed') container.dataset.reviewed = (!currentState).toString();
          if (action === 'flagged')  container.dataset.flagged  = (!currentState).toString();
        }
      } else {
        throw new Error(data.message || 'Update failed');
      }
    } catch (err) {
      console.error(err);
      showAlert(`Failed to update snapshot: ${err.message}`, 'danger');
    } finally {
      hideButtonLoading(button);
    }
  }

  function updateButton(button, action, newState) {
    const textSpan = button.querySelector('.btn-text');
    if (action === 'reviewed') {
      button.className = newState ? 'btn btn-sm btn-success mark-reviewed-btn' : 'btn btn-sm btn-outline-primary mark-reviewed-btn';
      textSpan.textContent = newState ? 'Unmark' : 'Mark Reviewed';
    } else {
      button.className = newState ? 'btn btn-sm btn-danger mark-flagged-btn' : 'btn btn-sm btn-outline-warning mark-flagged-btn';
      textSpan.textContent = newState ? 'Unflag' : 'Flag';
    }
    button.dataset.currentState = newState.toString();
  }

  function showButtonLoading(button) {
    button.querySelector('.btn-text').classList.add('d-none');
    button.querySelector('.loading-spinner').classList.remove('d-none');
    button.disabled = true;
  }
  function hideButtonLoading(button) {
    button.querySelector('.btn-text').classList.remove('d-none');
    button.querySelector('.loading-spinner').classList.add('d-none');
    button.disabled = false;
  }

  function showDownloadConfirmation() {
    const snapshotCount = document.querySelectorAll('[data-snapshot]').length;
    document.getElementById('download-count').textContent = snapshotCount;
    const mEl = ensureSingleModal('downloadConfirmModal');
    // If a previous backdrop got stuck, clean it up before showing
    if (window.cleanupModals) window.cleanupModals();
    const m = bootstrap.Modal.getOrCreateInstance(mEl, { backdrop: 'static', keyboard: true });
    m.show();
  }

  async function handleZipDownload() {
    const confirmBtn = document.getElementById('confirmDownloadBtn');
    showButtonLoading(confirmBtn);
    try {
      const currentUrl = new URL(window.location);
      currentUrl.searchParams.set('download', '1');
      const link = document.createElement('a');
      link.href = currentUrl.toString();
      link.click();
      setTimeout(() => bootstrap.Modal.getInstance(document.getElementById('downloadConfirmModal')).hide(), 800);
    } catch (e) {
      showAlert('Download failed. Please try again.', 'danger');
    } finally {
      hideButtonLoading(confirmBtn);
    }
  }

  function showAlert(message, type) {
    // Simple floating alert
    document.querySelectorAll('.alert.position-fixed').forEach(a => a.remove());
    const el = document.createElement('div');
    el.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    el.style.cssText = 'top:80px;right:20px;z-index:9999;min-width:300px;';
    el.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 4000);
  }
});
</script>
{% endblock %}

